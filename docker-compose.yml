version: "3.8"
services:
    traefik:
        image: traefik:v2.10
        command:
            - "--providers.docker=true"
            - "--entrypoints.websecure.address=:443"
            - "--certificatesresolvers.letsencrypt.acme.email=seu@email.com"
            - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
            - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
        ports:
            - "443:443"
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - ./letsencrypt:/letsencrypt
        networks:
            - vnc-network

    vnc-server:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: vnc-websocket-proxy
        expose:
            - "3101"
        environment:
            - NODE_ENV=production
            - PORT=3101
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.vnc.rule=Host(`novnc.noc.sh`)"
            - "traefik.http.routers.vnc.entrypoints=websecure"
            - "traefik.http.routers.vnc.tls.certresolver=letsencrypt"
            - "traefik.http.services.vnc.loadbalancer.server.port=3101"
        restart: unless-stopped
        networks:
            - vnc-network

networks:
    vnc-network:
        driver: bridge
